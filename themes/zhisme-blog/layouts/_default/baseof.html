<!DOCTYPE html>
<html lang="{{ site.Language.LanguageCode }}" dir="{{ or site.Language.LanguageDirection `ltr` }}">
  <head>
    {{ partial "head.html" . }}
  </head>
  <body>
    <div class="wrapper">
      <main class="page">
        {{ block "main" . }}{{ end }}
      </main>
      <footer>
        {{ partial "footer.html" . }}
      </footer>
    </div>

    <div class="cookie-block">
      <div>This site uses cookies for analytics.  </div>
      <a href="/privacy-policy/" class="button button-white-bg">Read more</a>
      <a href="javascript:void(0)" onclick="declineTracking()" class="button button-white-bg">No, thanks</a>
      <a href="javascript:void(0)" onclick="acceptTracking()" class="button button-green">Ok, got it</a>
    </div>

    {{ if eq hugo.Environment "production" }}
      {{ partial "comment-count.html" . }}
    {{ end }}

    <script type="text/javascript">
      // Check if user has made a choice
      const trackingChoice = localStorage.getItem('tracking-choice');

      if (!trackingChoice) {
        document.querySelector('.cookie-block').classList.add('visible');
        loadGoatCounter();
      } else if (trackingChoice === 'accepted') {
        loadGoogleAnalytics();
      } else if (trackingChoice === 'declined') {
        loadGoatCounter();
      }

      function acceptTracking() {
        localStorage.setItem('tracking-choice', 'accepted');
        document.querySelector('.cookie-block').classList.remove('visible');
        loadGoogleAnalytics();
      }

      function declineTracking() {
        localStorage.setItem('tracking-choice', 'declined');
        document.querySelector('.cookie-block').classList.remove('visible');
        // GoatCounter is already loaded or will load now
        if (!window.goatcounter) {
          loadGoatCounter();
        }
      }

      function loadGoogleAnalytics() {
        // Load GA4 script
        const gaScript = document.createElement('script');
        gaScript.src = 'https://www.googletagmanager.com/gtag/js?id=G-JKN6QF0DXY';
        gaScript.async = true;
        document.head.appendChild(gaScript);

        // Initialize GA4
        gaScript.onload = function() {
          window.dataLayer = window.dataLayer || [];
          function gtag(){dataLayer.push(arguments);}
          gtag('js', new Date());
          gtag('config', 'G-JKN6QF0DXY');
        };
      }

      function loadGoatCounter() {
        if (!window.goatcounter) {
          const script = document.createElement('script');
          script.setAttribute('data-goatcounter', 'https://zhisme.goatcounter.com/count');
          script.src = '//gc.zgo.at/count.js';
          script.async = true;
          document.head.appendChild(script);
        }
      }
    </script>
  </body>
</html>
